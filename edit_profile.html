<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Edit Profile</title>
<style>
/* ---------- Theme Variables ---------- */
:root {
  --bg-color: #f5f6fa;
  --text-color: #1f2937;
  --card-bg: #fff;
  --input-bg: #fff;
  --input-border: #ddd;
  --btn-bg: #2563eb;
  --btn-hover: #1d4ed8;
  --status-color: #dc2626;
}
body.dark {
  --bg-color: #1e293b;
  --text-color: #f3f4f6;
  --card-bg: #334155;
  --input-bg: #475569;
  --input-border: #64748b;
  --btn-bg: #3b82f6;
  --btn-hover: #2563eb;
  --status-color: #f87171;
}

/* ---------- Font Sizes ---------- */
body.small { font-size: 14px; }
body.medium { font-size: 16px; }
body.large { font-size: 18px; }

/* ---------- General Styles ---------- */
body {
  font-family: sans-serif;
  background: var(--bg-color);
  color: var(--text-color);
  margin:0;
  transition: background 0.3s, color 0.3s;
}
.container {
  max-width:500px;
  margin:2rem auto;
  padding:1.5rem;
  background: var(--card-bg);
  border-radius:12px;
  box-shadow:0 4px 12px rgba(0,0,0,0.08);
  transition: background 0.3s;
}
input, textarea {
  width:100%;
  margin-bottom:1rem;
  padding:0.75rem;
  border:1px solid var(--input-border);
  border-radius:8px;
  background: var(--input-bg);
  color: var(--text-color);
  box-sizing:border-box;
  transition: background 0.3s, border 0.3s, color 0.3s;
}
button {
  width:100%;
  padding:0.75rem;
  background: var(--btn-bg);
  color:white;
  border:none;
  border-radius:8px;
  cursor:pointer;
  transition: background 0.3s;
}
button:hover { background: var(--btn-hover); }
.profile-pic {
  display:block;
  margin:0 auto 1rem auto;
  width:100px;
  height:100px;
  border-radius:50%;
  object-fit:cover;
}
.status {
  text-align:center;
  margin-top:0.5rem;
  color: var(--status-color);
  font-size:0.95rem;
  min-height:1.2rem;
}
</style>
</head>
<body>
<div class="container">
  <h2>Edit Profile</h2>

  <form id="editForm" enctype="multipart/form-data" novalidate>
    {% if profile_pic %}
      <img src="{{ url_for('static', filename='uploads/' ~ profile_pic) }}" class="profile-pic" alt="Profile Picture">
    {% else %}
      <img src="https://via.placeholder.com/100" class="profile-pic" alt="Profile Picture">
    {% endif %}

    <label for="profile_pic">Change profile picture</label>
    <input id="profile_pic" type="file" name="profile_pic" accept="image/*">

    <input type="text" name="name" id="name" value="{{ name }}" placeholder="Full name">
    <input type="text" name="username" id="username" value="{{ username }}" placeholder="Username">
    <textarea name="bio" id="bio" placeholder="Your bio">{{ bio }}</textarea>
    <input type="password" name="password" id="password" placeholder="New Password (leave blank to keep)">
    <button type="button" id="saveBtn">Save Changes</button>

    <div id="status" class="status" aria-live="polite"></div>
  </form>
</div>

<script>
// ---------- Apply Theme + Font from localStorage ----------
(function applyUserSettings(){
  const theme = localStorage.getItem("theme") || "light";
  const fontSize = localStorage.getItem("fontSize") || "medium";
  document.body.classList.add(theme, fontSize);
})();

document.getElementById('saveBtn').addEventListener('click', submitEditProfileForm);

async function submitEditProfileForm(){
  const statusEl = document.getElementById('status');
  const btn = document.getElementById('saveBtn');
  statusEl.textContent = '';
  btn.disabled = true;
  btn.textContent = 'Saving...';

  try {
    const form = document.getElementById('editForm');
    const formData = new FormData(form);

    const resp = await fetch('/profile/edit', {
      method: 'POST',
      body: formData,
      credentials: 'same-origin'
    });

    const data = await resp.json();

    if (data && data.status === 'success') {
      window.location.href = '/profile';
      return;
    } else {
      statusEl.textContent = data.message || 'Something went wrong. Please try again.';
    }

  } catch (err) {
    console.error('Edit profile error:', err);
    statusEl.textContent = 'Network error. Check console for details.';
  } finally {
    btn.disabled = false;
    btn.textContent = 'Save Changes';
  }
}
</script>
</body>
</html>
